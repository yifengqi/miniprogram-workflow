# 开发问题记录

本文档记录项目开发过程中遇到的问题及解决方案。

---

## 问题 1：API连接测试失败 - HTML错误响应

### 问题现象
```
连接测试失败: Unexpected token '<', "<!doctype "... is not valid JSON
```

### 问题原因
1. **API端点URL配置错误**：用户配置的中转站API地址不正确或路径错误
2. **服务器返回HTML错误页面**：API服务器返回了HTML格式的错误页面（404、500等），而代码尝试将其解析为JSON
3. **缺少错误类型判断**：代码没有检查响应的Content-Type，直接尝试JSON解析

### 解决办法

修改 `src/api/ai.js` 文件，添加详细的错误处理：

```javascript
// OpenAI 兼容格式 (OpenAI, DeepSeek, 中转站等)
response = await fetch(apiUrl, {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
    'Authorization': `Bearer ${apiKey}`
  },
  body: JSON.stringify({
    model,
    messages,
    max_tokens: options.maxTokens || 4096,
    temperature: options.temperature ?? 0.7,
    stream: false
  })
})

// 检查响应状态
if (!response.ok) {
  const text = await response.text()
  // 检查是否是HTML错误页面
  if (text.trim().startsWith('<!DOCTYPE') || text.trim().startsWith('<html')) {
    throw new Error(`API请求失败 (${response.status}): 服务器返回了错误页面，请检查API端点URL是否正确`)
  }
  throw new Error(`API请求失败 (${response.status}): ${text}`)
}

// 检查Content-Type
const contentType = response.headers.get('content-type')
if (!contentType || !contentType.includes('application/json')) {
  const text = await response.text()
  throw new Error(`API返回了非JSON格式数据，请检查API端点URL是否正确。返回内容: ${text.substring(0, 100)}`)
}

const data = await response.json()

if (data.error) {
  throw new Error(data.error.message || 'API 调用失败')
}

return data.choices?.[0]?.message?.content || ''
```

### 优化效果
- ✅ 清晰的错误提示，用户能明确知道是URL配置问题
- ✅ 避免混淆的JSON解析错误
- ✅ 显示HTTP状态码，方便排查问题
- ✅ 对HTML错误页面进行特殊处理

---

## 问题 2：需求收集表单独立访问

### 问题现象
- 需求收集功能绑定在项目管理系统内，客户无法独立访问
- 客户需要登录系统才能填写需求
- 无法通过链接或二维码分享给客户填写

### 问题原因
1. **耦合度高**：需求收集表单依赖项目管理系统的状态
2. **缺少公共页面**：没有独立的、无需登录的需求收集页面
3. **数据隔离不足**：客户提交的需求和内部项目数据混在一起

### 解决办法

#### 1. 创建独立的公共需求收集页面

新建 `src/views/PublicRequirement.vue`：

**核心功能**：
- ✅ 独立访问路径：`/public-form`
- ✅ 无需登录，任何人都可访问
- ✅ 支持电脑网页、手机网页访问
- ✅ 自动保存草稿（localStorage）
- ✅ 提交后生成唯一ID
- ✅ 移动端响应式优化

**关键代码**：
```javascript
// 表单提交
function submitForm() {
  // 生成提交ID
  submissionId.value = 'REQ-' + Date.now() + '-' + Math.random().toString(36).substr(2, 6).toUpperCase()
  
  // 保存到localStorage
  const submissions = JSON.parse(localStorage.getItem('public_submissions') || '[]')
  submissions.push({
    id: submissionId.value,
    data: { ...form },
    submittedAt: new Date().toISOString()
  })
  localStorage.setItem('public_submissions', JSON.stringify(submissions))
  
  // 清除草稿
  localStorage.removeItem('public_requirement_draft')
  
  submitSuccess.value = true
}
```

**移动端优化**：
```css
@media (max-width: 768px) {
  .public-requirement-page {
    padding: 12px;
  }
  
  .form-actions {
    flex-direction: column;
    gap: 12px;
  }
  
  .actions-right {
    width: 100%;
    flex-direction: column;
  }
}
```

#### 2. 创建提交记录管理页面

新建 `src/views/Submissions.vue`：

**核心功能**：
- ✅ 查看所有客户提交记录
- ✅ 搜索功能（项目名称、联系方式）
- ✅ 查看详情（Markdown格式）
- ✅ 导出Markdown文件
- ✅ 一键导入到项目
- ✅ 复制表单链接
- ✅ 生成二维码（用于扫码填写）

**链接分享**：
```javascript
const publicUrl = computed(() => {
  return window.location.origin + '/public-form'
})

function copyPublicUrl() {
  navigator.clipboard.writeText(publicUrl.value)
  ElMessage.success('链接已复制到剪贴板')
}
```

**二维码生成**：
```javascript
function generateQRCode() {
  qrcodeVisible.value = true
  
  // 动态加载 qrcode 库
  if (!window.QRCode) {
    const script = document.createElement('script')
    script.src = 'https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js'
    script.onload = () => {
      new window.QRCode(qrcodeContainer.value, {
        text: publicUrl.value,
        width: 256,
        height: 256
      })
    }
    document.head.appendChild(script)
  }
}
```

#### 3. 更新路由配置

修改 `src/router/index.js`：

```javascript
{
  path: '/public-form',
  name: 'PublicRequirement',
  component: () => import('@/views/PublicRequirement.vue'),
  meta: { title: '需求收集表', public: true }
},
{
  path: '/submissions',
  name: 'Submissions',
  component: () => import('@/views/Submissions.vue'),
  meta: { title: '客户提交' }
}
```

### 使用方式

#### 方式1：分享链接
1. 进入「客户提交」页面
2. 点击「复制表单链接」
3. 将链接发送给客户（微信、邮件等）
4. 客户点击链接即可在浏览器中填写

#### 方式2：二维码扫描
1. 进入「客户提交」页面
2. 点击「生成二维码」
3. 保存二维码图片或展示给客户
4. 客户使用微信扫码即可填写

#### 方式3：电脑填写
1. 直接访问：`https://你的域名/public-form`
2. 在电脑浏览器中填写更方便

### 数据流转

```
客户填写表单
    ↓
提交到localStorage (public_submissions)
    ↓
生成唯一ID (REQ-时间戳-随机码)
    ↓
管理员查看提交记录
    ↓
选择导入到项目
    ↓
自动创建项目并导入需求数据
    ↓
进入正常开发流程
```

### 优化效果
- ✅ 客户体验提升：无需注册登录，直接填写
- ✅ 移动端友好：手机上也能流畅填写
- ✅ 数据不丢失：草稿自动保存
- ✅ 便于分享：链接+二维码两种方式
- ✅ 管理便捷：统一查看和导入
- ✅ 数据隔离：客户提交和内部项目分开存储

---

## 技术细节

### 数据存储结构

#### 公共提交数据
```javascript
// localStorage key: 'public_submissions'
[
  {
    id: "REQ-1707234567890-ABC123",
    data: {
      appName: "项目名称",
      background: "项目背景",
      // ... 其他表单字段
      contact: "联系方式"
    },
    submittedAt: "2026-02-06T12:34:56.789Z"
  }
]
```

#### 草稿数据
```javascript
// localStorage key: 'public_requirement_draft'
{
  appName: "项目名称",
  background: "项目背景",
  // ... 表单当前填写的所有字段
}
```

### 响应式设计要点

1. **步骤指示器**：移动端使用简化模式（simple）
2. **按钮布局**：移动端改为垂直排列，宽度100%
3. **表单间距**：移动端减小padding，提高空间利用率
4. **字体大小**：移动端适当调整标题字体

### 安全考虑

1. **数据验证**：必填项验证，联系方式必填
2. **数据清理**：提交后清除草稿，避免重复提交
3. **唯一ID**：使用时间戳+随机码保证唯一性
4. **本地存储**：所有数据存储在localStorage，不涉及服务器

---

## 总结

本次更新解决了两个核心问题：
1. **API错误处理优化**：提供清晰的错误提示，帮助用户快速定位问题
2. **独立需求收集**：实现客户无需登录即可填写需求，支持多种分享方式

这些改进大大提升了系统的易用性和客户体验。

---

## 问题 3：Git推送失败 - HTTP2网络错误

### 问题现象
```
fatal: unable to access 'https://github.com/...': Error in the HTTP2 framing layer
```

### 问题原因
1. **网络连接问题**：HTTP/2协议在当前网络环境下不稳定
2. **GitHub服务问题**：GitHub服务器可能暂时不可用或网络波动
3. **代理或防火墙**：网络代理或防火墙可能干扰HTTP/2连接

### 解决办法

#### 方案1：使用SSH协议（推荐）
```bash
# 切换到SSH远程地址
git remote set-url origin git@github.com:用户名/仓库名.git

# 确保SSH密钥已配置
ssh -T git@github.com

# 推送
git push origin main
```

#### 方案2：手动在终端推送
```bash
# 在系统终端（非Cursor内）执行
cd "项目目录"
git push origin main
```

#### 方案3：使用GitHub Desktop
1. 打开GitHub Desktop应用
2. 选择当前仓库
3. 点击"Push origin"按钮

#### 方案4：切换到HTTP/1.1
```bash
git config --global http.version HTTP/1.1
git push origin main
```

#### 方案5：检查并重试
```bash
# 测试GitHub连接
curl -I https://github.com

# 更换网络环境后重试
git push origin main
```

### 优化效果
- ✅ 本地提交已成功保存
- ⚠️ 推送可通过其他方式完成
- ✅ 代码安全性不受影响

### 最佳实践
1. **优先使用SSH协议**：SSH通常更稳定
2. **配置SSH密钥**：避免每次输入密码
3. **保持Git更新**：使用最新版本
4. **备选方案**：准备多种推送方式

---

**更新时间**：2026-02-06  
**更新人**：AI Assistant  
**记录问题数**：3个
