# 🧠 知识库自动进化系统设计

**核心理念**：每个项目都是学习机会，系统越用越聪明

---

## 🎯 自动进化目标

**让AI从每个项目中学习**：
- ✅ 记录问题和解决方案
- ✅ 对比优化前后差异
- ✅ 总结经验和最佳实践
- ✅ 自动应用到下一个项目
- ✅ 持续优化生成质量

---

## 📊 知识库结构设计

### 1. 知识条目格式

```json
{
  "id": "exp-2026-02-06-001",
  "timestamp": "2026-02-06T10:30:00Z",
  "project": {
    "id": "project-xxx",
    "name": "演唱会抢票小程序",
    "type": "工具类",
    "industry": "娱乐"
  },
  "category": "需求分析",
  "issue": {
    "title": "客户需求描述不清晰导致PRD偏差",
    "description": "客户说'抢票'，但没说清是个人用还是商业用",
    "impact": "PRD生成了商业版本，需要重新生成",
    "severity": "medium"
  },
  "solution": {
    "before": {
      "approach": "直接根据客户原始描述生成PRD",
      "problem": "容易产生理解偏差"
    },
    "after": {
      "approach": "在需求收集阶段增加'使用场景'必填项",
      "improvement": "明确区分个人工具 vs 商业平台"
    },
    "diff": [
      "需求表单增加'目标用户'字段（个人/企业）",
      "需求表单增加'预期使用规模'字段",
      "PRD生成前先做场景分类"
    ]
  },
  "lessons": [
    "工具类小程序必须明确是ToC还是ToB",
    "涉及抢购/抢票的需求，要明确法律风险",
    "AI生成PRD前要先做需求澄清"
  ],
  "autoActions": [
    {
      "trigger": "需求中包含'抢票'关键词",
      "action": "自动弹出提示：请明确是个人工具还是商业平台",
      "applied": true
    }
  ],
  "metrics": {
    "timeWasted": "2小时",
    "timeSavedNextTime": "预计1.5小时",
    "roi": "75%"
  },
  "tags": ["需求澄清", "场景识别", "法律风险", "工具类小程序"],
  "applyToFutureProjects": true
}
```

### 2. 知识库分类体系

```
经验知识库/
├── 01_需求收集阶段/
│   ├── 需求澄清技巧.json
│   ├── 常见误解案例.json
│   └── 必问问题清单.json
│
├── 02_PRD生成阶段/
│   ├── 常见遗漏功能.json
│   ├── 技术选型建议.json
│   └── 数据库设计经验.json
│
├── 03_Demo开发阶段/
│   ├── 常见Bug模式.json
│   ├── 性能优化点.json
│   └── 代码质量问题.json
│
├── 04_迭代优化阶段/
│   ├── 客户反馈分析.json
│   ├── 需求变更处理.json
│   └── UI调整经验.json
│
├── 05_上线检查阶段/
│   ├── 审核被拒原因.json
│   ├── 合规问题清单.json
│   └── 性能问题案例.json
│
└── 06_行业知识/
    ├── 电商类小程序.json
    ├── 工具类小程序.json
    ├── 社区类小程序.json
    └── 服务预约类.json
```

---

## 🔄 自动记录机制

### 1. 项目生命周期记录

```javascript
// src/stores/experienceLibrary.js

export const useExperienceStore = defineStore('experience', {
  state: () => ({
    experiences: [],
    projectLogs: {}  // 每个项目的完整日志
  }),
  
  actions: {
    // 🔴 关键：记录项目每个阶段
    logProjectStage(projectId, stage, data) {
      if (!this.projectLogs[projectId]) {
        this.projectLogs[projectId] = {
          project: projectStore.getProjectById(projectId),
          timeline: [],
          issues: [],
          improvements: []
        }
      }
      
      this.projectLogs[projectId].timeline.push({
        stage,
        timestamp: new Date().toISOString(),
        data,
        snapshot: this.captureSnapshot(projectId, stage)
      })
      
      this.saveToStorage()
    },
    
    // 🔴 关键：捕获状态快照
    captureSnapshot(projectId, stage) {
      const project = projectStore.getProjectById(projectId)
      
      return {
        stage,
        requirement: project.requirement,
        prdClient: project.prdClient,
        prdDev: project.prdDev,
        demoCode: project.demoCode,
        iterationCount: project.iterations?.length || 0
      }
    },
    
    // 🔴 关键：记录问题和解决
    recordIssue(projectId, issue) {
      const log = this.projectLogs[projectId]
      if (!log) return
      
      const issueRecord = {
        id: `issue-${Date.now()}`,
        timestamp: new Date().toISOString(),
        stage: projectStore.getProjectById(projectId).stage,
        ...issue,
        snapshot: {
          before: this.captureSnapshot(projectId, 'before_fix'),
          after: null  // 修复后填充
        }
      }
      
      log.issues.push(issueRecord)
      this.saveToStorage()
      
      return issueRecord.id
    },
    
    // 🔴 关键：记录解决后状态
    recordIssueSolved(projectId, issueId, solution) {
      const log = this.projectLogs[projectId]
      const issue = log.issues.find(i => i.id === issueId)
      
      if (issue) {
        issue.snapshot.after = this.captureSnapshot(projectId, 'after_fix')
        issue.solution = solution
        issue.solved = true
        issue.solvedAt = new Date().toISOString()
        
        // 🔴 自动分析差异
        issue.diff = this.analyzeDiff(
          issue.snapshot.before,
          issue.snapshot.after
        )
        
        this.saveToStorage()
      }
    },
    
    // 🔴 关键：分析前后差异
    analyzeDiff(before, after) {
      const diff = {
        changes: [],
        improvements: [],
        metrics: {}
      }
      
      // 对比需求变化
      if (before.requirement !== after.requirement) {
        diff.changes.push({
          field: 'requirement',
          before: before.requirement,
          after: after.requirement,
          reason: '需求优化'
        })
      }
      
      // 对比PRD变化
      if (before.prdClient !== after.prdClient) {
        diff.changes.push({
          field: 'prdClient',
          linesChanged: this.calculateLinesDiff(
            before.prdClient, 
            after.prdClient
          ),
          reason: 'PRD优化'
        })
      }
      
      // 对比迭代次数
      if (after.iterationCount > before.iterationCount) {
        diff.metrics.additionalIterations = 
          after.iterationCount - before.iterationCount
      }
      
      return diff
    },
    
    // 🔴 关键：项目完成时生成经验总结
    async generateProjectExperience(projectId) {
      const log = this.projectLogs[projectId]
      if (!log) return
      
      // 1. 准备完整日志数据
      const projectData = {
        project: log.project,
        timeline: log.timeline,
        issues: log.issues,
        improvements: log.improvements,
        totalTime: this.calculateProjectTime(log),
        iterationCount: log.timeline.filter(t => 
          t.stage === 'iteration'
        ).length
      }
      
      // 2. 调用AI分析
      const prompt = `
请分析以下项目的完整日志，提取经验教训：

项目信息：
${JSON.stringify(projectData, null, 2)}

请按以下格式输出：

## 关键问题
1. 问题描述
2. 发生原因
3. 解决方案
4. 优化前后对比

## 经验教训
1. 在XXX阶段要注意...
2. 避免...
3. 推荐...

## 可复用的改进
1. 需求表单增加XXX字段
2. PRD模板增加XXX检查点
3. 自动提示规则：如果...则...

## 应用建议
未来遇到类似项目（XXX类型），建议：
1. ...
2. ...

输出JSON格式。
`
      
      const aiAnalysis = await callAI(prompt)
      
      // 3. 保存到知识库
      const experience = {
        id: `exp-${Date.now()}`,
        projectId,
        timestamp: new Date().toISOString(),
        project: log.project,
        analysis: aiAnalysis,
        rawLog: projectData,
        applyToFutureProjects: true
      }
      
      this.experiences.push(experience)
      
      // 4. 自动更新标准化流程文档
      await this.updateStandardDocs(experience)
      
      this.saveToStorage()
      
      return experience
    },
    
    // 🔴 关键：自动更新标准化文档
    async updateStandardDocs(experience) {
      // 更新 07_经验知识库.md
      const currentDoc = await readFile('标准化开发流程/07_经验知识库.md')
      
      const newEntry = `
---

## ${experience.project.name}（${experience.timestamp}）

### 项目背景
- 类型：${experience.project.type}
- 行业：${experience.project.industry}

### 关键问题
${this.formatIssues(experience.analysis.issues)}

### 解决方案
${this.formatSolutions(experience.analysis.solutions)}

### 经验教训
${this.formatLessons(experience.analysis.lessons)}

### 优化对比
**优化前**：
${this.formatBefore(experience)}

**优化后**：
${this.formatAfter(experience)}

**差异点**：
${this.formatDiff(experience)}

### 应用建议
${this.formatRecommendations(experience.analysis.recommendations)}

---
`
      
      await appendToFile(
        '标准化开发流程/07_经验知识库.md',
        newEntry
      )
    }
  }
})
```

---

## 🎯 自动应用机制

### 1. 智能提示系统

```javascript
// src/utils/intelligentHints.js

class IntelligentHintSystem {
  constructor() {
    this.experienceStore = useExperienceStore()
    this.rules = []
    this.loadRulesFromExperience()
  }
  
  // 从经验库加载规则
  loadRulesFromExperience() {
    const experiences = this.experienceStore.experiences
    
    experiences.forEach(exp => {
      if (exp.autoActions) {
        exp.autoActions.forEach(action => {
          if (action.applied) {
            this.rules.push({
              trigger: action.trigger,
              hint: action.action,
              source: exp.id,
              confidence: exp.metrics?.roi || 0.5
            })
          }
        })
      }
    })
  }
  
  // 🔴 关键：检查是否应该触发提示
  checkHints(context) {
    const hints = []
    
    this.rules.forEach(rule => {
      if (this.matchTrigger(rule.trigger, context)) {
        hints.push({
          message: rule.hint,
          source: rule.source,
          confidence: rule.confidence
        })
      }
    })
    
    return hints
  }
  
  // 匹配触发条件
  matchTrigger(trigger, context) {
    // 关键词匹配
    if (trigger.keywords) {
      return trigger.keywords.some(keyword => 
        context.text?.includes(keyword)
      )
    }
    
    // 场景匹配
    if (trigger.scenario) {
      return context.scenario === trigger.scenario
    }
    
    // 项目类型匹配
    if (trigger.projectType) {
      return context.projectType === trigger.projectType
    }
    
    return false
  }
}

export const hintSystem = new IntelligentHintSystem()
```

### 2. 需求收集时自动提示

```vue
<!-- PublicRequirement.vue -->
<template>
  <div class="public-requirement">
    <!-- 智能提示 -->
    <el-alert 
      v-for="hint in intelligentHints" 
      :key="hint.source"
      type="warning"
      :closable="false"
      style="margin-bottom: 16px"
    >
      <template #title>
        💡 基于历史经验的建议（成功率：{{ hint.confidence * 100 }}%）
      </template>
      {{ hint.message }}
    </el-alert>
    
    <!-- 需求表单 -->
    <el-form v-model="form" @input="checkIntelligentHints">
      <!-- ... -->
    </el-form>
  </div>
</template>

<script setup>
import { hintSystem } from '@/utils/intelligentHints'

const intelligentHints = ref([])

// 🔴 实时检查智能提示
function checkIntelligentHints() {
  intelligentHints.value = hintSystem.checkHints({
    text: form.background + form.appName,
    scenario: 'requirement_collection',
    projectType: form.appType
  })
}
</script>
```

### 3. PRD生成时应用经验

```javascript
// src/api/ai.js

export async function generateClientPRD(requirement) {
  // 🔴 关键：加载相关经验
  const relevantExperiences = experienceStore.findRelevant({
    projectType: requirement.appType,
    stage: 'prd_generation'
  })
  
  // 🔴 关键：将经验注入到Prompt
  const experienceContext = relevantExperiences.map(exp => `
【历史经验】
项目：${exp.project.name}
问题：${exp.issue.title}
教训：${exp.lessons.join('; ')}
建议：${exp.solution.after.approach}
`).join('\n\n')
  
  const prompt = `
你是一个专业的产品经理，正在为客户生成PRD文档。

【相关历史经验】
${experienceContext}

【当前需求】
${JSON.stringify(requirement)}

请参考历史经验，避免重复犯错，生成高质量的PRD。

特别注意：
${relevantExperiences.map(exp => 
  `- ${exp.lessons[0]}`
).join('\n')}
`
  
  return await callAI(prompt)
}
```

---

## 📊 进化效果可视化

### 1. 知识库统计页面

```vue
<template>
  <div class="evolution-dashboard">
    <h1>系统进化统计</h1>
    
    <!-- 总体指标 -->
    <el-row :gutter="20">
      <el-col :span="6">
        <el-statistic title="累积项目数" :value="totalProjects" />
      </el-col>
      <el-col :span="6">
        <el-statistic title="记录经验条目" :value="totalExperiences" />
      </el-col>
      <el-col :span="6">
        <el-statistic title="活跃智能提示" :value="activeHints" />
      </el-col>
      <el-col :span="6">
        <el-statistic 
          title="平均效率提升" 
          :value="avgEfficiencyGain" 
          suffix="%" 
        />
      </el-col>
    </el-row>
    
    <!-- 进化趋势图 -->
    <el-card title="PRD生成质量趋势">
      <div ref="qualityChart" style="height: 300px"></div>
    </el-card>
    
    <!-- 常见问题Top10 -->
    <el-card title="最常见的问题和解决方案">
      <el-table :data="topIssues">
        <el-table-column prop="issue" label="问题" />
        <el-table-column prop="frequency" label="出现次数" />
        <el-table-column prop="solution" label="解决方案" />
        <el-table-column label="已应用">
          <template #default="{ row }">
            <el-tag :type="row.applied ? 'success' : 'info'">
              {{ row.applied ? '已自动应用' : '待应用' }}
            </el-tag>
          </template>
        </el-table-column>
      </el-table>
    </el-card>
    
    <!-- 经验应用效果 -->
    <el-card title="经验应用效果对比">
      <el-descriptions :column="2">
        <el-descriptions-item label="应用经验前">
          平均PRD生成时间：{{ beforeMetrics.avgTime }}分钟<br>
          需求澄清次数：{{ beforeMetrics.clarifications }}次<br>
          返工率：{{ beforeMetrics.reworkRate }}%
        </el-descriptions-item>
        <el-descriptions-item label="应用经验后">
          平均PRD生成时间：{{ afterMetrics.avgTime }}分钟<br>
          需求澄清次数：{{ afterMetrics.clarifications }}次<br>
          返工率：{{ afterMetrics.reworkRate }}%
        </el-descriptions-item>
      </el-descriptions>
    </el-card>
  </div>
</template>
```

---

## 🔄 项目完成时的经验总结流程

### 自动化流程

```javascript
// 项目标记为完成时
async function completeProject(projectId) {
  // 1. 生成项目总结
  ElMessageBox.confirm(
    '项目即将完成，是否生成经验总结并更新知识库？',
    '项目完成',
    {
      confirmButtonText: '生成经验总结',
      cancelButtonText: '跳过',
      type: 'success'
    }
  ).then(async () => {
    // 2. 显示处理进度
    const loading = ElLoading.service({
      text: 'AI正在分析项目日志，生成经验总结...'
    })
    
    try {
      // 3. AI分析生成经验
      const experience = await experienceStore.generateProjectExperience(projectId)
      
      // 4. 展示经验总结
      showExperienceSummary(experience)
      
      // 5. 询问是否应用到未来项目
      ElMessageBox.confirm(
        `
发现以下可优化点：
${experience.analysis.improvements.map((imp, i) => 
  `${i + 1}. ${imp}`
).join('\n')}

是否立即应用到系统中？`,
        '应用改进',
        {
          confirmButtonText: '立即应用',
          cancelButtonText: '暂不应用'
        }
      ).then(() => {
        // 6. 应用改进
        applyImprovements(experience)
        ElMessage.success('改进已应用，下个项目将自动受益！')
      })
      
    } finally {
      loading.close()
    }
  })
}
```

---

## 🎯 自动进化的核心价值

### 1. 越用越聪明

```
第1个项目：
- 需求收集：手动填写，可能遗漏关键信息
- PRD生成：AI基础能力，可能有通用问题
- 返工次数：3次

第5个项目：
- 需求收集：自动提示必填项，智能检查遗漏
- PRD生成：AI已学会避开常见坑，质量更高
- 返工次数：1次

第20个项目：
- 需求收集：针对行业的智能问卷，几乎零遗漏
- PRD生成：行业最佳实践自动应用，一次通过
- 返工次数：0次
```

### 2. 知识复用和传承

```
场景：新接了一个"电商小程序"项目

系统自动：
1. 读取过往3个电商项目的经验
2. 在需求收集时自动提示：
   "历史经验：电商类项目要注意支付流程、库存管理、订单状态"
3. 生成PRD时自动包含：
   "基于历史经验，建议增加：购物车、优惠券、物流跟踪"
4. 自动检查清单已包含：
   "支付资质、商品审核、售后流程"

结果：
- 新项目避免了过往所有坑
- PRD质量更高
- 开发周期更短
```

### 3. 持续优化

```
系统会自动：
1. 统计哪些提示最有效（命中率、采纳率）
2. 优化提示的时机和内容
3. 淘汰无效的规则
4. 强化高价值的经验

就像机器学习一样，系统在不断自我优化！
```

---

## 📝 实施清单

### Phase 1A：核心自动化（今天）
- [ ] 项目状态机
- [ ] AI任务队列
- [ ] 立项自动触发PRD

### Phase 1B：经验记录系统（明天）⭐⭐⭐
- [ ] 经验Store设计
- [ ] 项目日志记录
- [ ] 问题和解决记录
- [ ] 前后对比功能
- [ ] 自动差异分析

### Phase 1C：智能提示系统（后天）
- [ ] 提示规则引擎
- [ ] 需求收集智能提示
- [ ] PRD生成经验应用
- [ ] 提示效果统计

### Phase 2：经验总结和进化（下周）
- [ ] 项目完成自动总结
- [ ] AI分析生成经验
- [ ] 自动更新知识库文档
- [ ] 经验可视化看板
- [ ] 进化效果统计

---

**关键**：经验系统是整个自动化的"大脑"，它让系统从"工具"变成"智能助手"！🧠✨
