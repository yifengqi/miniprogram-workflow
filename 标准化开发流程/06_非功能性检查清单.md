# ⚠️ 非功能性检查清单

> **重要提醒**：本文档是小程序开发中最容易忽略但最容易出问题的地方！
> 每次上线前务必逐项检查，避免踩坑

---

## 为什么需要这个清单？

作为开发新手和非技术客户，以下问题经常被忽略：

1. **合规问题** → 小程序审核不通过，无法上线
2. **权限问题** → 用户无法使用某些功能
3. **安全问题** → 数据泄露，法律风险
4. **性能问题** → 用户体验差，流失严重
5. **兼容问题** → 部分手机无法使用

**本清单基于星见项目实践经验，涵盖80%以上的常见坑点。**

---

## 一、合规与审核

### 1.0 协议文档生成【重要】

> **AI自动分析并生成**：根据项目的具体功能，AI需要分析需要哪些协议文档，并生成完整版和简介版

#### 让AI分析需要的协议

在项目开发阶段，向AI提供以下信息，让AI分析需要准备的协议文档：

```markdown
请根据以下项目信息，分析需要准备哪些协议文档：

【项目名称】：XXX
【核心功能】：
- 功能1（如：用户注册登录）
- 功能2（如：内容发布）
- 功能3（如：在线支付）
...

【收集的用户信息】：
- 信息1（如：手机号）
- 信息2（如：位置信息）
...

【特殊功能】：
- 是否有UGC内容：是/否
- 是否有支付功能：是/否
- 是否有社区互动：是/否
- 是否有位置服务：是/否
...

请分析需要哪些协议，并为每个协议生成：
1. 【完整版】：用于正式展示，包含完整法律条款
2. 【简介版】：用于弹窗快速浏览，提炼核心要点
```

#### 常见需要的协议文档

| 协议类型 | 何时需要 | 必须程度 |
|---------|---------|---------|
| **隐私政策** | 任何小程序都需要 | 必须 |
| **用户协议/服务条款** | 需要用户注册或登录 | 必须 |
| **社区规范** | 有UGC内容或社区互动 | 建议 |
| **支付协议/退款政策** | 有在线支付功能 | 必须 |
| **知识产权声明** | 有原创内容或版权内容 | 建议 |
| **免责声明** | 提供信息服务或工具 | 建议 |
| **儿童隐私保护** | 面向儿童或可能有儿童用户 | 必须 |

#### AI生成协议的格式要求

```markdown
## [协议名称] - 完整版

【适用范围】：[说明本协议适用的产品/服务]
【生效日期】：[日期]
【版本号】：v1.0

### 第一条 总则
...

### 第二条 ...
...

---

## [协议名称] - 简介版（弹窗用）

**核心要点：**
1. [要点1：30字以内]
2. [要点2：30字以内]
3. [要点3：30字以内]
...

**完整协议请查看：**[链接/按钮]
```

#### 协议文档存放位置

```
项目根目录/
├── docs/
│   └── legal/                      # 法律文档目录
│       ├── 隐私政策_完整版.md
│       ├── 隐私政策_简介版.md
│       ├── 用户协议_完整版.md
│       ├── 用户协议_简介版.md
│       └── ...
└── pages/
    └── legal/                      # 协议展示页面
        ├── privacy.vue             # 隐私政策页面
        └── terms.vue               # 用户协议页面
```

---

### 1.1 隐私协议【必须】

#### 检查项
- [ ] 已让AI根据项目功能生成隐私政策（完整版+简介版）
- [ ] 有隐私政策页面或弹窗
- [ ] 首次使用时提示用户同意
- [ ] 不同意则无法使用（或限制功能）
- [ ] 隐私政策内容与实际收集的信息一致

#### 隐私政策必须包含
```
1. 收集哪些信息（姓名、手机号、位置等）
2. 为什么收集这些信息
3. 如何存储和保护信息
4. 是否与第三方共享
5. 用户如何查看/删除自己的信息
6. 联系方式
```

#### 隐私弹窗组件示例
```vue
<!-- components/PrivacyModal.vue -->
<template>
  <view v-if="visible" class="privacy-modal">
    <view class="privacy-modal__content">
      <text class="privacy-modal__title">用户隐私保护提示</text>
      <text class="privacy-modal__text">
        在您使用本小程序前，请仔细阅读
        <text class="privacy-modal__link" @tap="viewPrivacy">《隐私政策》</text>
        和
        <text class="privacy-modal__link" @tap="viewTerms">《用户协议》</text>
        。点击"同意"表示您已阅读并同意上述协议。
      </text>
      <view class="privacy-modal__buttons">
        <button class="btn-cancel" @tap="reject">不同意</button>
        <button class="btn-primary" @tap="accept">同意</button>
      </view>
    </view>
  </view>
</template>
```

#### 小程序后台配置
```
小程序后台 → 设置 → 基本设置 → 服务内容声明 → 用户隐私保护指引
```

### 1.2 用户协议【必须】

#### 检查项
- [ ] 已让AI根据项目功能生成用户协议（完整版+简介版）
- [ ] 有用户协议/服务条款页面
- [ ] 注册时需勾选同意
- [ ] 协议内容与实际服务一致

#### 用户协议必须包含
```
1. 服务内容说明
2. 用户行为规范
3. 知识产权声明
4. 免责条款
5. 争议解决方式
6. 协议变更说明
```

### 1.2.1 其他协议（根据项目需要）

#### 检查项
- [ ] 已让AI分析项目需要的其他协议
- [ ] 所有必要协议都已生成（完整版+简介版）
- [ ] 协议页面已创建并可正常访问
- [ ] 弹窗简介版可正确显示

### 1.3 小程序类目【必须】

#### 检查项
- [ ] 选择的类目与实际功能匹配
- [ ] 如涉及特殊类目，已准备资质文件

#### 常见需要资质的类目
| 类目 | 所需资质 |
|------|---------|
| 电商/交易 | 营业执照 |
| 金融 | 金融许可证 |
| 医疗 | 医疗相关资质 |
| 教育 | 办学许可证 |
| 餐饮 | 食品经营许可证 |
| 预约服务 | 可能需要营业执照 |

### 1.4 内容审核【重要】

#### 如果有用户生成内容（UGC）
- [ ] 实现敏感词过滤
- [ ] 实现内容审核机制（人工或自动）
- [ ] 有内容举报功能
- [ ] 有违规内容处理机制

#### 敏感词过滤示例
```javascript
// cloudfunctions/common/security.js
const sensitiveWords = ['违禁词1', '违禁词2', ...]

function checkSensitive(content) {
  for (const word of sensitiveWords) {
    if (content.includes(word)) {
      return { hasSensitive: true, word }
    }
  }
  return { hasSensitive: false }
}
```

#### 使用微信内容安全API
```javascript
// 调用微信内容安全接口
const result = await cloud.openapi.security.msgSecCheck({
  content: userContent
})
if (result.errcode !== 0) {
  return fail(400, '内容包含违规信息')
}
```

### 1.5 审核常见驳回原因

| 驳回原因 | 解决方案 |
|---------|---------|
| 缺少隐私政策 | 添加隐私政策页面和弹窗 |
| 类目不符 | 重新选择正确类目 |
| 功能不完整 | 补充完整功能或隐藏未完成入口 |
| 无法正常体验 | 提供测试账号 |
| 存在虚假宣传 | 修改宣传语，实事求是 |
| 涉及交易无资质 | 提供相关资质或调整功能 |

---

## 二、权限管理

### 2.1 微信权限申请【重要】

#### 常用权限及申请时机

| 权限 | scope | 使用场景 | 申请时机 |
|------|-------|---------|---------|
| 手机号 | - | 登录注册 | 点击授权按钮时 |
| 位置 | scope.userLocation | 定位、导航 | 需要使用时 |
| 相机 | scope.camera | 拍照、扫码 | 点击拍照时 |
| 相册 | scope.writePhotosAlbum | 保存图片 | 点击保存时 |
| 蓝牙 | scope.bluetooth | 蓝牙设备 | 连接设备时 |

#### 权限申请标准流程
```javascript
// utils/permission.js
export async function requestPermission(scope, tips) {
  try {
    // 1. 检查当前权限状态
    const setting = await uni.getSetting()
    
    // 2. 已授权，直接返回
    if (setting.authSetting[scope]) {
      return true
    }
    
    // 3. 未授权，请求授权
    try {
      await uni.authorize({ scope })
      return true
    } catch (e) {
      // 4. 用户拒绝，引导去设置
      const res = await uni.showModal({
        title: '权限申请',
        content: tips || '需要您授权相关权限才能使用此功能',
        confirmText: '去设置'
      })
      
      if (res.confirm) {
        await uni.openSetting()
        // 重新检查
        const newSetting = await uni.getSetting()
        return !!newSetting.authSetting[scope]
      }
      return false
    }
  } catch (error) {
    console.error('权限申请失败:', error)
    return false
  }
}

// 使用示例
async function saveImage() {
  const hasPermission = await requestPermission(
    'scope.writePhotosAlbum',
    '保存图片需要您授权相册权限'
  )
  if (!hasPermission) {
    uni.showToast({ title: '未授权，无法保存', icon: 'none' })
    return
  }
  // 继续保存操作...
}
```

#### 权限申请原则
1. **按需申请**：用到的时候再申请，不要启动就申请一堆
2. **说明用途**：申请时告诉用户为什么需要
3. **优雅降级**：用户拒绝后要有替代方案或友好提示
4. **引导设置**：拒绝后提供去设置页面的入口

### 2.2 数据库权限【必须】

#### 权限配置原则
```
1. 最小权限原则：只给必要的权限
2. 读写分离：大多数表 read: true/条件, write: false
3. 通过云函数写入：所有写操作通过云函数，在云函数中验证权限
```

#### 常用权限配置模板
```json
// 公开可读，云函数可写
{
  "read": true,
  "write": false
}

// 仅自己可读，云函数可写
{
  "read": "doc._openid == auth.openid",
  "write": false
}

// 仅自己可读写
{
  "read": "doc._openid == auth.openid",
  "write": "doc._openid == auth.openid"
}

// 管理员可读
{
  "read": "get('database.users.doc(auth.openid)').role >= 6",
  "write": false
}
```

---

## 三、安全防护

### 3.1 数据安全【必须】

#### 敏感数据处理
- [ ] 手机号脱敏显示（138****1234）
- [ ] 身份证脱敏显示（前4后4）
- [ ] 密码不明文存储（使用hash）
- [ ] 敏感信息加密存储

#### 脱敏工具函数
```javascript
// utils/security.js

// 手机号脱敏
export function maskPhone(phone) {
  if (!phone || phone.length !== 11) return phone
  return phone.replace(/(\d{3})\d{4}(\d{4})/, '$1****$2')
}

// 身份证脱敏
export function maskIdCard(idCard) {
  if (!idCard || idCard.length < 8) return idCard
  return idCard.replace(/(\d{4})\d+(\d{4})/, '$1**********$2')
}

// 姓名脱敏
export function maskName(name) {
  if (!name) return ''
  if (name.length === 2) {
    return name[0] + '*'
  }
  return name[0] + '*'.repeat(name.length - 2) + name[name.length - 1]
}

// 邮箱脱敏
export function maskEmail(email) {
  if (!email) return ''
  const [name, domain] = email.split('@')
  if (!domain) return email
  const maskedName = name.length > 3 
    ? name.slice(0, 3) + '***' 
    : name[0] + '**'
  return `${maskedName}@${domain}`
}
```

### 3.2 接口安全【必须】

#### 参数验证
```javascript
// 在云函数中验证所有输入
function validateParams(params, rules) {
  for (const [key, rule] of Object.entries(rules)) {
    const value = params[key]
    
    // 必填检查
    if (rule.required && !value) {
      return { valid: false, error: `缺少参数: ${key}` }
    }
    
    // 类型检查
    if (value && rule.type && typeof value !== rule.type) {
      return { valid: false, error: `参数类型错误: ${key}` }
    }
    
    // 正则检查
    if (value && rule.pattern && !rule.pattern.test(value)) {
      return { valid: false, error: `参数格式错误: ${key}` }
    }
    
    // 长度检查
    if (value && rule.maxLength && value.length > rule.maxLength) {
      return { valid: false, error: `参数过长: ${key}` }
    }
  }
  return { valid: true }
}

// 使用
const validation = validateParams(params, {
  phone: { required: true, pattern: /^1[3-9]\d{9}$/ },
  name: { required: true, maxLength: 20 },
  age: { type: 'number' }
})
if (!validation.valid) {
  return fail(400, validation.error)
}
```

#### XSS防护
```javascript
// 过滤HTML标签
function escapeHtml(str) {
  if (!str) return ''
  return str
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#039;')
}

// 存储前过滤
const safeContent = escapeHtml(userInput)
```

#### 防重复提交
```javascript
// 前端：按钮防重复点击
const submitting = ref(false)

async function handleSubmit() {
  if (submitting.value) return
  
  submitting.value = true
  try {
    await doSubmit()
  } finally {
    submitting.value = false
  }
}

// 后端：幂等性校验
// 使用唯一请求ID，避免重复处理
```

### 3.3 请求频率限制【建议】

```javascript
// 云函数中实现简单的频率限制
const RATE_LIMIT_COLLECTION = 'rate_limits'
const MAX_REQUESTS = 100  // 每分钟最多100次
const WINDOW_MS = 60000   // 1分钟窗口

async function checkRateLimit(openid, action) {
  const key = `${openid}_${action}`
  const now = Date.now()
  const windowStart = now - WINDOW_MS
  
  const db = cloud.database()
  const _ = db.command
  
  // 清理过期记录
  await db.collection(RATE_LIMIT_COLLECTION)
    .where({
      key,
      timestamp: _.lt(windowStart)
    })
    .remove()
  
  // 统计当前窗口请求数
  const count = await db.collection(RATE_LIMIT_COLLECTION)
    .where({ key, timestamp: _.gte(windowStart) })
    .count()
  
  if (count.total >= MAX_REQUESTS) {
    return false  // 超过限制
  }
  
  // 记录本次请求
  await db.collection(RATE_LIMIT_COLLECTION).add({
    data: { key, timestamp: now }
  })
  
  return true
}
```

---

## 四、错误处理与用户反馈

### 4.1 错误提示【必须】

#### 用户友好的错误提示
```javascript
// 错误码映射表
const ERROR_MESSAGES = {
  400: '请求参数有误，请检查输入',
  401: '请先登录',
  403: '无权限进行此操作',
  404: '内容不存在或已删除',
  500: '服务暂时不可用，请稍后重试',
  'NETWORK_ERROR': '网络连接失败，请检查网络',
  'TIMEOUT': '请求超时，请稍后重试'
}

function showError(error) {
  const code = error.code || error.errCode
  const message = ERROR_MESSAGES[code] || error.message || '操作失败'
  
  uni.showToast({
    title: message,
    icon: 'none',
    duration: 2000
  })
}
```

#### 不要暴露技术细节
```javascript
// ❌ 不好的做法
uni.showToast({ title: 'TypeError: Cannot read property of undefined' })

// ✅ 好的做法
uni.showToast({ title: '加载失败，请稍后重试' })

// 错误详情记录到日志，不展示给用户
console.error('错误详情:', error)
```

### 4.2 加载状态【必须】

#### 全局加载提示
```javascript
// 封装加载提示
const loadingCount = ref(0)

function showLoading(title = '加载中...') {
  loadingCount.value++
  if (loadingCount.value === 1) {
    uni.showLoading({ title, mask: true })
  }
}

function hideLoading() {
  loadingCount.value = Math.max(0, loadingCount.value - 1)
  if (loadingCount.value === 0) {
    uni.hideLoading()
  }
}
```

#### 骨架屏加载
```vue
<template>
  <!-- 骨架屏 -->
  <view v-if="loading" class="skeleton">
    <view class="skeleton-avatar"></view>
    <view class="skeleton-line"></view>
    <view class="skeleton-line short"></view>
  </view>
  
  <!-- 实际内容 -->
  <view v-else>
    <!-- ... -->
  </view>
</template>

<style>
.skeleton-avatar,
.skeleton-line {
  background: linear-gradient(90deg, #1a1a1a 25%, #2a2a2a 50%, #1a1a1a 75%);
  background-size: 200% 100%;
  animation: shimmer 1.5s infinite;
}

@keyframes shimmer {
  0% { background-position: 200% 0; }
  100% { background-position: -200% 0; }
}
</style>
```

### 4.3 空状态处理【必须】

```vue
<template>
  <view v-if="!loading && !list.length" class="empty-state">
    <image class="empty-state__image" src="/static/empty.png" />
    <text class="empty-state__title">暂无内容</text>
    <text class="empty-state__desc">快去添加第一条内容吧</text>
    <button class="empty-state__button" @tap="goAdd">去添加</button>
  </view>
</template>
```

### 4.4 网络异常处理【必须】

```javascript
// 监听网络状态
uni.onNetworkStatusChange((res) => {
  if (!res.isConnected) {
    uni.showToast({
      title: '网络已断开',
      icon: 'none'
    })
  } else if (res.networkType === '2g') {
    uni.showToast({
      title: '当前网络较慢',
      icon: 'none'
    })
  }
})

// 请求失败重试
async function fetchWithRetry(fn, retries = 3) {
  for (let i = 0; i < retries; i++) {
    try {
      return await fn()
    } catch (error) {
      if (i === retries - 1) throw error
      await sleep(1000 * (i + 1))  // 递增延迟
    }
  }
}
```

---

## 五、性能优化

### 5.1 首屏加载优化【重要】

#### 分包加载配置
```json
// pages.json
{
  "pages": [
    // 主包只放必要页面
    { "path": "pages/home/index" },
    { "path": "pages/login/index" }
  ],
  "subPackages": [
    {
      "root": "pages_sub",
      "pages": [
        { "path": "detail/index" },
        { "path": "search/index" }
      ]
    }
  ]
}
```

#### 预加载配置
```json
// pages.json
{
  "preloadRule": {
    "pages/home/index": {
      "network": "wifi",
      "packages": ["pages_sub"]
    }
  }
}
```

### 5.2 图片优化【重要】

#### 图片懒加载
```vue
<image 
  :src="imageUrl" 
  lazy-load
  mode="aspectFill"
/>
```

#### 图片压缩上传
```javascript
async function compressAndUpload(filePath) {
  // 压缩图片
  const compressed = await uni.compressImage({
    src: filePath,
    quality: 80  // 压缩质量
  })
  
  // 上传
  const result = await wx.cloud.uploadFile({
    cloudPath: `images/${Date.now()}.jpg`,
    filePath: compressed.tempFilePath
  })
  
  return result.fileID
}
```

#### 使用缩略图
```javascript
// 列表页使用缩略图，详情页使用原图
const thumbnailUrl = originalUrl + '?imageView2/2/w/200'  // 云存储支持的裁剪参数
```

### 5.3 数据缓存【建议】

```javascript
// utils/cache.js

const CACHE_PREFIX = 'app_cache_'
const DEFAULT_EXPIRE = 5 * 60 * 1000  // 5分钟

export function setCache(key, data, expire = DEFAULT_EXPIRE) {
  const cacheData = {
    data,
    expire: Date.now() + expire
  }
  uni.setStorageSync(CACHE_PREFIX + key, cacheData)
}

export function getCache(key) {
  const cacheData = uni.getStorageSync(CACHE_PREFIX + key)
  if (!cacheData) return null
  
  if (Date.now() > cacheData.expire) {
    uni.removeStorageSync(CACHE_PREFIX + key)
    return null
  }
  
  return cacheData.data
}

export function removeCache(key) {
  uni.removeStorageSync(CACHE_PREFIX + key)
}

// 使用示例
async function getUserInfo() {
  // 先查缓存
  const cached = getCache('userInfo')
  if (cached) return cached
  
  // 缓存没有，请求接口
  const data = await callCloud('user', { action: 'getInfo' })
  
  // 存入缓存
  setCache('userInfo', data, 10 * 60 * 1000)  // 10分钟
  
  return data
}
```

### 5.4 列表性能优化【建议】

#### 虚拟列表（长列表优化）
```vue
<!-- 对于超长列表（>100项），使用虚拟列表 -->
<scroll-view 
  scroll-y 
  :scroll-into-view="scrollIntoView"
  @scroll="handleScroll"
>
  <!-- 只渲染可视区域的项 -->
  <view 
    v-for="item in visibleList" 
    :key="item.id"
    :style="{ transform: `translateY(${item.offsetTop}px)` }"
  >
    <!-- 内容 -->
  </view>
</scroll-view>
```

#### 分页加载
```javascript
const list = ref([])
const page = ref(1)
const pageSize = 20
const hasMore = ref(true)
const loading = ref(false)

async function loadMore() {
  if (loading.value || !hasMore.value) return
  
  loading.value = true
  const newData = await fetchList(page.value, pageSize)
  
  list.value.push(...newData)
  hasMore.value = newData.length === pageSize
  page.value++
  loading.value = false
}
```

---

## 六、兼容性检查

### 6.1 设备兼容【必须】

#### 不同屏幕尺寸
- [ ] iPhone SE（小屏）
- [ ] iPhone 14（标准）
- [ ] iPhone 14 Pro Max（大屏）
- [ ] iPad（平板）
- [ ] Android 各尺寸

#### 使用rpx适配
```css
/* 使用rpx自动适配 */
.container {
  padding: 32rpx;  /* 不要用px */
  font-size: 28rpx;
}
```

#### 安全区域适配
```vue
<template>
  <view :style="{ paddingBottom: safeAreaBottom + 'px' }">
    <!-- 底部固定内容 -->
  </view>
</template>

<script setup>
const safeAreaBottom = ref(0)

onMounted(() => {
  const systemInfo = uni.getSystemInfoSync()
  safeAreaBottom.value = systemInfo.safeAreaInsets?.bottom || 0
})
</script>
```

### 6.2 系统版本兼容【必须】

#### 检查基础库版本
```javascript
// 检查是否支持某个API
if (!wx.canIUse('button.open-type.getPhoneNumber')) {
  uni.showToast({
    title: '请更新微信版本',
    icon: 'none'
  })
  return
}
```

#### 设置最低基础库版本
```
小程序后台 → 设置 → 基本设置 → 基础库最低版本 → 建议2.20.0以上
```

### 6.3 深色模式适配【建议】

```javascript
// 监听系统主题变化
uni.onThemeChange((res) => {
  if (res.theme === 'dark') {
    // 切换到深色模式
  } else {
    // 切换到浅色模式
  }
})

// 获取当前主题
const systemInfo = uni.getSystemInfoSync()
const isDarkMode = systemInfo.theme === 'dark'
```

---

## 七、云开发检查

### 7.1 云函数配置【必须】

#### package.json版本
```json
{
  "dependencies": {
    "wx-server-sdk": "~2.6.3"  // 必须用2.6.x，不能用3.x！
  }
}
```

#### config.json格式
```json
{
  "permissions": {
    "openapi": []
  }
}
// 注意：不要包含 "env": "" 字段！
```

#### 超时配置
```json
// config.json
{
  "timeout": 60,  // 超时时间（秒），最大60
  "memorySize": 256  // 内存大小（MB）
}
```

### 7.2 数据库索引【重要】

#### 常用索引配置
```javascript
// 必须建立索引的场景：
// 1. 经常用于查询条件的字段
// 2. 排序字段
// 3. 分页查询的字段

// 示例索引
{ status: 1, created_at: -1 }  // 状态+时间复合索引
{ openid: 1 }                   // 用户ID索引
{ activity_id: 1, user_id: 1 } // 复合唯一索引
```

#### 索引数量限制
- 单个集合最多20个索引
- 复合索引最多包含10个字段

### 7.3 配额监控【建议】

定期检查云开发用量：
- [ ] 云函数调用次数
- [ ] 数据库读写次数
- [ ] 云存储容量
- [ ] CDN流量

---

## 八、上线前终极检查

### 8.1 功能检查
- [ ] 所有主要功能已测试
- [ ] 边界情况已处理
- [ ] 错误提示已完善

### 8.2 合规检查
- [ ] 隐私政策已添加
- [ ] 用户协议已添加
- [ ] 类目选择正确
- [ ] 资质文件已准备（如需）

### 8.3 安全检查
- [ ] 敏感数据已脱敏
- [ ] 输入验证已实现
- [ ] 数据库权限已配置
- [ ] 无敏感信息硬编码
- [ ] 🔴 **积分/优惠系统**：前端防篡改（不信任前端传值）
- [ ] 🔴 **支付系统**：后端校验金额，防止0元支付
- [ ] 🔴 **关键操作**：后端完整日志记录（谁、何时、做了什么）
- [ ] 🔴 **接口防刷**：频率限制（Rate Limiting）
- [ ] 🔴 **防重放攻击**：请求签名+时间戳校验
- [ ] 🔴 **SQL注入/XSS**：参数化查询+输出转义

### 8.4 性能检查
- [ ] 首屏加载<3秒
- [ ] 列表滚动流畅
- [ ] 图片已压缩
- [ ] 无内存泄漏

### 8.5 兼容性检查
- [ ] iOS真机测试通过
- [ ] Android真机测试通过
- [ ] 不同屏幕尺寸测试
- [ ] 弱网络环境测试

### 8.6 发布前准备
- [ ] 测试账号已准备
- [ ] 版本号已更新
- [ ] 更新日志已写
- [ ] 备份当前版本

---

## 九、常见问题速查

| 问题 | 可能原因 | 解决方案 |
|------|---------|---------|
| 审核不通过 | 隐私政策缺失 | 添加隐私弹窗和政策页 |
| 登录失败 | 权限未配置 | 检查数据库权限 |
| 图片不显示 | 域名未配置 | 添加downloadFile域名 |
| 云函数报错 | SDK版本问题 | 使用2.6.3版本 |
| 页面空白 | 路由配置错误 | 检查pages.json |
| 数据丢失 | 权限不足 | 检查数据库权限规则 |

---

## 十、🔴 积分/支付/高并发安全专项检查【极重要】

> **核心原则**：永远不要信任前端！一切涉及金额、积分、优惠的操作必须后端校验。
> **来源**：项目实战血泪经验

### 10.1 积分/优惠系统三重审核

#### 前端审核
- [ ] 积分显示值从后端获取，不在前端计算
- [ ] 优惠券/折扣信息从后端获取，前端仅展示
- [ ] 前端不传递积分数值和优惠金额给后端
- [ ] 按钮防重复点击（loading状态+节流）

#### 后端审核
- [ ] 积分增减必须在后端完成计算
- [ ] 优惠计算在后端完成，不接受前端传值
- [ ] 金额一致性校验（订单金额=商品金额-优惠金额+运费）
- [ ] 积分余额校验（扣减前检查余额是否足够）
- [ ] 操作幂等性（同一请求重复执行结果一致）

#### 后端记录（必须）
- [ ] 积分变动完整日志（用户ID、变动值、变动原因、时间、IP）
- [ ] 支付操作完整日志（订单号、金额、支付状态、回调结果）
- [ ] 管理员操作审计日志
- [ ] 异常操作告警（如短时间大量积分变动）

### 10.2 支付系统安全

- [ ] 支付金额后端计算，不接受前端传值
- [ ] 微信支付回调验签
- [ ] 支付状态机（待支付→支付中→已支付→已退款）
- [ ] 退款金额校验（不能超过原支付金额）
- [ ] 订单超时自动关闭
- [ ] 支付结果对账机制
- [ ] 防止0元支付漏洞
- [ ] 防止修改支付金额（中间人攻击）

### 10.3 高并发防护

- [ ] 接口频率限制（Rate Limiting）：单用户每秒/每分钟请求上限
- [ ] 库存/积分扣减使用数据库事务+乐观锁
- [ ] 秒杀/抢购场景使用队列削峰
- [ ] 缓存热点数据，减轻数据库压力
- [ ] 服务熔断和降级策略

### 10.4 恶意攻击防范

- [ ] 接口鉴权（所有敏感接口需要登录态）
- [ ] 参数校验（类型、范围、长度）
- [ ] 防SQL注入（参数化查询）
- [ ] 防XSS攻击（输出转义）
- [ ] 防CSRF攻击（Token校验）
- [ ] 防重放攻击（请求签名+时间戳+nonce）
- [ ] IP黑名单机制
- [ ] 验证码防机器人（关键操作前）
- [ ] 文件上传安全（类型、大小、内容检查）
- [ ] 敏感信息加密传输（HTTPS + 关键字段加密）

### 10.5 快速检查表

| 风险项 | 检查要点 | 后果 |
|--------|---------|------|
| 前端传积分 | 后端独立计算 | 用户刷积分 |
| 前端传金额 | 后端独立计算 | 0元购买 |
| 无操作日志 | 添加完整日志 | 无法追溯 |
| 无频率限制 | 添加Rate Limit | 接口被刷崩 |
| 无事务控制 | 添加数据库事务 | 数据不一致 |
| 无签名校验 | 添加请求签名 | 接口被篡改 |

---

**文档版本**：v1.1  
**更新时间**：2026-02-06  
**新增内容**：积分/支付/高并发安全专项检查（第十章）  
**基于项目**：星见StelRen小程序实践经验
