# 📚 经验知识库

> **AI必读文档**：每次开始新项目或新对话时，请先阅读本文档
> 本文档持续积累项目经验，帮助AI避免重复踩坑

---

## 🎯 文档说明

### 本文档的作用
1. **记录问题**：开发过程中遇到的坑
2. **记录方案**：如何解决这些问题
3. **量化收益**：优化前后的对比（时间/代码量/效果）
4. **持续迭代**：每个项目结束后更新

### AI如何使用本文档
1. 开始新项目时，先阅读【快速检索区】了解常见问题
2. 开发过程中，遇到问题先查【问题分类索引】
3. 项目结束时，将新发现的问题添加到本文档

### 文档结构
```
经验知识库/
├── 快速检索区          # 高频问题速查
├── 问题分类索引        # 按类型分类的问题列表
├── 详细经验记录        # 每个问题的完整信息
└── 更新日志           # 文档更新记录
```

---

## ⚡ 快速检索区

> 这里列出最常见、最容易踩的坑，AI每次开始项目时快速浏览

### 必看TOP 10

| 序号 | 问题 | 关键解决方案 | 详细位置 |
|------|------|-------------|---------|
| 1 | wx-server-sdk版本问题 | 必须用 ~2.6.3 | [#EXP-001](#exp-001-云函数sdk版本问题) |
| 2 | 数据库权限配置 | 分离读写，云函数写入 | [#EXP-002](#exp-002-数据库权限问题) |
| 3 | 隐私弹窗遗漏 | 首次进入必须弹窗 | [#EXP-003](#exp-003-隐私合规问题) |
| 4 | 路由路径不一致 | vite base 和 router history 必须一致 | [#EXP-004](#exp-004-web后台路由问题) |
| 5 | CSS变量未定义 | 在App.vue全局定义 | [#EXP-005](#exp-005-css变量问题) |
| 6 | 云函数config.json格式 | 不要包含空的env字段 | [#EXP-006](#exp-006-云函数配置问题) |
| 7 | Vue3生命周期写法 | 使用@dcloudio/uni-app导入 | [#EXP-007](#exp-007-vue3生命周期问题) |
| 8 | 图片URL转换 | cloud:// 需要转临时URL | [#EXP-008](#exp-008-云存储url问题) |
| 9 | 自定义导航栏适配 | 动态获取状态栏和胶囊高度 | [#EXP-009](#exp-009-导航栏适配问题) |
| 10 | 弱网和离线处理 | 缓存机制和重试逻辑 | [#EXP-010](#exp-010-网络异常处理) |

---

## 📂 问题分类索引

### 云开发相关
- [#EXP-001](#exp-001-云函数sdk版本问题) 云函数SDK版本问题
- [#EXP-002](#exp-002-数据库权限问题) 数据库权限问题
- [#EXP-006](#exp-006-云函数配置问题) 云函数配置问题
- [#EXP-008](#exp-008-云存储url问题) 云存储URL问题

### 前端相关
- [#EXP-005](#exp-005-css变量问题) CSS变量问题
- [#EXP-007](#exp-007-vue3生命周期问题) Vue3生命周期问题
- [#EXP-009](#exp-009-导航栏适配问题) 导航栏适配问题

### 部署相关
- [#EXP-004](#exp-004-web后台路由问题) Web后台路由问题

### 合规相关
- [#EXP-003](#exp-003-隐私合规问题) 隐私合规问题

### 用户体验相关
- [#EXP-010](#exp-010-网络异常处理) 网络异常处理

---

## 📝 详细经验记录

> 每条记录包含：问题描述、错误现象、解决方案、优化收益

---

### EXP-001 云函数SDK版本问题

**问题分类**：云开发  
**严重程度**：🔴 致命  
**首次发现**：星见项目 2026-02  
**最后更新**：2026-02-06

#### 问题描述
云函数使用 wx-server-sdk 3.x 版本导致上传失败或运行时错误

#### 错误现象
```
上传云函数时报错
或
运行时出现 [ACCESS_TOKEN_DISABLED] 错误
或
云函数调用返回空结果
```

#### 原因分析
wx-server-sdk 3.x 版本与当前云开发环境不兼容

#### 解决方案
```json
// package.json
{
  "dependencies": {
    "wx-server-sdk": "~2.6.3"  // 必须用2.6.x
  }
}
```

#### 优化收益
| 指标 | 优化前 | 优化后 | 收益 |
|------|--------|--------|------|
| 上传成功率 | 0% | 100% | +100% |
| 调试时间 | 2小时 | 0 | -2小时 |

---

### EXP-002 数据库权限问题

**问题分类**：云开发  
**严重程度**：🔴 致命  
**首次发现**：星见项目 2026-02  
**最后更新**：2026-02-06

#### 问题描述
数据库权限配置不当导致读写失败

#### 错误现象
```
小程序端读取数据返回空数组
或
写入数据报权限错误
或
跨用户数据无法访问
```

#### 原因分析
1. 权限配置过于严格，导致无法读取
2. 权限配置过于宽松，存在安全风险
3. 不理解 doc._openid 和 auth.openid 的区别

#### 解决方案
```json
// 推荐的权限配置策略

// 公开可读的数据（如活动列表）
{ "read": true, "write": false }

// 仅自己可读的数据（如订单）
{ "read": "doc._openid == auth.openid", "write": false }

// 所有写操作通过云函数进行
```

#### 最佳实践
1. **读写分离**：大多数表设置 write: false
2. **云函数写入**：所有写操作通过云函数，在云函数中验证权限
3. **按需开放读**：根据业务需求设置读权限

#### 优化收益
| 指标 | 优化前 | 优化后 | 收益 |
|------|--------|--------|------|
| 权限错误数 | 5+次/项目 | 0次 | -100% |
| 安全风险 | 高 | 低 | 显著降低 |

---

### EXP-003 隐私合规问题

**问题分类**：合规  
**严重程度**：🔴 致命（影响上线）  
**首次发现**：星见项目 2026-02  
**最后更新**：2026-02-06

#### 问题描述
缺少隐私政策或用户协议导致审核不通过

#### 错误现象
```
小程序提交审核被驳回
驳回原因：缺少隐私政策/用户隐私保护指引未填写
```

#### 解决方案
1. **隐私弹窗**：首次进入小程序时弹出
2. **隐私政策页面**：完整的隐私政策文档
3. **用户协议页面**：完整的服务条款
4. **后台配置**：填写用户隐私保护指引

#### 关键代码
```vue
<!-- App.vue 中检查隐私同意状态 -->
<script setup>
import { onLaunch } from '@dcloudio/uni-app'

onLaunch(() => {
  const agreed = uni.getStorageSync('privacy_agreed')
  if (!agreed) {
    // 显示隐私弹窗或跳转隐私页面
  }
})
</script>
```

#### 优化收益
| 指标 | 优化前 | 优化后 | 收益 |
|------|--------|--------|------|
| 审核通过率 | 0% | 100% | 可正常上线 |

---

### EXP-004 Web后台路由问题

**问题分类**：部署  
**严重程度**：🟠 严重  
**首次发现**：星见项目 2026-02  
**最后更新**：2026-02-06

#### 问题描述
Web管理后台部署到子目录后页面空白或路由失效

#### 错误现象
```
访问管理后台显示空白页
或
刷新页面后 404
或
路由跳转失败
```

#### 原因分析
vite.config.js 的 base 和 router 的 history 路径不一致

#### 解决方案
```javascript
// vite.config.js
export default defineConfig({
  base: '/admin/',  // 部署路径
  // ...
})

// router/index.js
const router = createRouter({
  history: createWebHistory('/admin/'),  // 必须与base一致！
  routes
})
```

#### 优化收益
| 指标 | 优化前 | 优化后 | 收益 |
|------|--------|--------|------|
| 部署调试时间 | 3小时 | 10分钟 | -170分钟 |

---

### EXP-005 CSS变量问题

**问题分类**：前端  
**严重程度**：🟡 一般  
**首次发现**：星见项目 2026-02  
**最后更新**：2026-02-06

#### 问题描述
不同模块使用的CSS变量名称不一致，导致样式异常

#### 错误现象
```
按钮文字颜色看不清（黑色背景+黑色文字）
或
样式在某些页面正常，某些页面异常
```

#### 解决方案
在 App.vue 中统一定义所有CSS变量：
```css
page {
  /* 颜色变量 */
  --primary-color: #D4AF37;
  --text-primary: #FFFFFF;
  --text-secondary: #999999;
  --bg-primary: #000000;
  --bg-secondary: #111111;
  
  /* 兼容不同命名 */
  --color-primary: var(--primary-color);
  --color-text: var(--text-primary);
}
```

#### 优化收益
| 指标 | 优化前 | 优化后 | 收益 |
|------|--------|--------|------|
| 样式调试时间 | 1小时/页面 | 5分钟/页面 | -55分钟 |

---

### EXP-006 云函数配置问题

**问题分类**：云开发  
**严重程度**：🟠 严重  
**首次发现**：星见项目 2026-02  
**最后更新**：2026-02-06

#### 问题描述
云函数 config.json 格式错误导致上传或运行失败

#### 错误现象
```
云函数上传失败
或
云函数运行时环境变量异常
```

#### 解决方案
```json
// 正确的 config.json 格式
{
  "permissions": {
    "openapi": []
  }
}

// ❌ 错误：不要包含空的env字段
{
  "env": "",  // 删除这行！
  "permissions": {
    "openapi": []
  }
}
```

#### 优化收益
| 指标 | 优化前 | 优化后 | 收益 |
|------|--------|--------|------|
| 配置错误次数 | 频繁 | 0 | 节省调试时间 |

---

### EXP-007 Vue3生命周期问题

**问题分类**：前端  
**严重程度**：🟠 严重  
**首次发现**：星见项目 2026-02  
**最后更新**：2026-02-06

#### 问题描述
Vue3 + UniApp 中生命周期钩子使用方式错误

#### 错误现象
```
TypeError: common_vendor.index.onPullDownRefresh is not a function
或
页面生命周期不触发
```

#### 原因分析
Vue3 `<script setup>` 中不能使用 `uni.onXXX()` 的方式

#### 解决方案
```javascript
// ❌ 错误写法
uni.onPullDownRefresh(() => {
  // ...
})

// ✅ 正确写法
import { onPullDownRefresh, onReachBottom, onLoad } from '@dcloudio/uni-app'

onPullDownRefresh(async () => {
  await loadData()
  uni.stopPullDownRefresh()
})

onReachBottom(() => {
  loadMore()
})

onLoad((options) => {
  console.log(options)
})
```

#### 优化收益
| 指标 | 优化前 | 优化后 | 收益 |
|------|--------|--------|------|
| 运行时错误 | 页面崩溃 | 正常运行 | 功能可用 |

---

### EXP-008 云存储URL问题

**问题分类**：云开发  
**严重程度**：🟡 一般  
**首次发现**：星见项目 2026-02  
**最后更新**：2026-02-06

#### 问题描述
云存储的 cloud:// 协议URL无法直接在小程序中显示图片

#### 错误现象
```
图片显示不出来
或
图片加载失败
```

#### 解决方案
在云函数中批量转换为临时URL：
```javascript
// 云函数中
const fileList = items
  .filter(item => item.cover?.startsWith('cloud://'))
  .map(item => ({ fileID: item.cover }))

if (fileList.length > 0) {
  const urls = await cloud.getTempFileURL({ fileList })
  
  // 映射回原数据
  items.forEach(item => {
    const matched = urls.fileList.find(f => f.fileID === item.cover)
    if (matched) {
      item.cover_url = matched.tempFileURL
    }
  })
}
```

#### 优化收益
| 指标 | 优化前 | 优化后 | 收益 |
|------|--------|--------|------|
| 图片显示成功率 | 0% | 100% | 功能可用 |

---

### EXP-009 导航栏适配问题

**问题分类**：前端  
**严重程度**：🟡 一般  
**首次发现**：星见项目 2026-02  
**最后更新**：2026-02-06

#### 问题描述
自定义导航栏在不同手机上对齐异常

#### 错误现象
```
返回按钮与胶囊不对齐
或
内容被导航栏遮挡
或
状态栏区域显示异常
```

#### 解决方案
动态获取系统信息并计算高度：
```javascript
const systemInfo = uni.getSystemInfoSync()
const menuButton = uni.getMenuButtonBoundingClientRect()

// 状态栏高度
const statusBarHeight = systemInfo.statusBarHeight || 0

// 导航栏高度 = (胶囊顶部间距 × 2) + 胶囊高度
const navBarHeight = (menuButton.top - statusBarHeight) * 2 + menuButton.height

// 总高度
const totalNavHeight = statusBarHeight + navBarHeight
```

```vue
<template>
  <view class="navbar" :style="{ paddingTop: statusBarHeight + 'px' }">
    <view class="navbar__content" :style="{ height: navBarHeight + 'px' }">
      <!-- 内容 -->
    </view>
  </view>
  <view :style="{ marginTop: totalNavHeight + 'px' }">
    <!-- 页面内容 -->
  </view>
</template>
```

#### 优化收益
| 指标 | 优化前 | 优化后 | 收益 |
|------|--------|--------|------|
| 适配机型覆盖 | 部分机型 | 100%机型 | 全量适配 |

---

### EXP-010 网络异常处理

**问题分类**：用户体验  
**严重程度**：🟡 一般  
**首次发现**：星见项目 2026-02  
**最后更新**：2026-02-06

#### 问题描述
弱网或离线环境下用户体验差

#### 错误现象
```
页面长时间loading无反馈
或
操作失败无提示
或
已输入的内容丢失
```

#### 解决方案
1. **网络状态监听**
```javascript
uni.onNetworkStatusChange((res) => {
  if (!res.isConnected) {
    uni.showToast({ title: '网络已断开', icon: 'none' })
  }
})
```

2. **请求超时处理**
```javascript
const TIMEOUT = 10000  // 10秒

async function requestWithTimeout(fn) {
  const timeout = new Promise((_, reject) => 
    setTimeout(() => reject(new Error('请求超时')), TIMEOUT)
  )
  return Promise.race([fn(), timeout])
}
```

3. **重试机制**
```javascript
async function fetchWithRetry(fn, retries = 3) {
  for (let i = 0; i < retries; i++) {
    try {
      return await fn()
    } catch (error) {
      if (i === retries - 1) throw error
      await new Promise(r => setTimeout(r, 1000 * (i + 1)))
    }
  }
}
```

4. **本地缓存**
```javascript
// 先显示缓存数据，再请求最新
const cached = uni.getStorageSync('data_cache')
if (cached) {
  list.value = cached
}

const fresh = await fetchData()
list.value = fresh
uni.setStorageSync('data_cache', fresh)
```

#### 优化收益
| 指标 | 优化前 | 优化后 | 收益 |
|------|--------|--------|------|
| 弱网体验评分 | 差 | 良好 | 显著提升 |
| 用户流失率 | 高 | 低 | 降低流失 |

---

## 📊 更新日志

> 记录知识库的每次更新

| 日期 | 更新内容 | 来源项目 |
|------|---------|---------|
| 2026-02-06 | 初始化知识库，添加10条核心经验 | 星见StelRen |

---

## 🔄 如何添加新经验

当项目中遇到新问题并解决后，按以下格式添加：

```markdown
### EXP-XXX [问题简述]

**问题分类**：[云开发/前端/部署/合规/用户体验]  
**严重程度**：[🔴 致命 / 🟠 严重 / 🟡 一般]  
**首次发现**：[项目名] [日期]  
**最后更新**：[日期]

#### 问题描述
[简要描述问题]

#### 错误现象
```
[错误信息或现象]
```

#### 原因分析
[问题产生的原因]

#### 解决方案
```
[具体的解决代码或步骤]
```

#### 优化收益
| 指标 | 优化前 | 优化后 | 收益 |
|------|--------|--------|------|
| [指标名] | [值] | [值] | [差值] |
```

同时更新：
1. 【快速检索区】的TOP 10（如果是高频问题）
2. 【问题分类索引】
3. 【更新日志】

---

## 🔴 高优先级经验（必读）

### 经验 #H001：积分/支付/优惠系统 - 三重审核机制

**来源**：项目实战经验  
**优先级**：⭐⭐⭐⭐⭐ (5/5) - 必读  
**标签**：`issue:security` `biz:payment` `biz:points` `risk:financial`

#### 核心教训

> **永远不要信任前端！** 一切涉及金额、积分、优惠的操作，必须做到"三重审核"。

#### 问题场景

| 场景 | 风险 | 后果 |
|------|------|------|
| 前端传递积分数值 | 用户修改请求参数 | 无限刷积分 |
| 前端传递支付金额 | 用户篡改金额为0 | 0元购买 |
| 无操作日志 | 出事后无法追溯 | 损失无法定量 |

#### 解决方案：三重审核

**1. 前端审核（防君子）**
```
- 积分/金额仅展示，不参与计算
- 按钮防重复点击
- 基本参数校验
```

**2. 后端审核（防小人）**
```
- 独立计算金额和积分（不信任前端传值）
- 操作幂等性（重复请求结果一致）
- 余额/库存实时校验
- 数据库事务保证一致性
```

**3. 后端记录（防翻车）**
```
- 完整操作日志（谁、何时、做了什么、IP地址）
- 异常操作告警（短时间大量操作）
- 定期对账审计
```

#### 适用项目类型
- 电商（支付、优惠券、满减）
- 会员系统（积分、等级、权益）
- 游戏（虚拟货币、道具）
- 社区（打赏、红包）
- 预约系统（定金、退款）

---

### 经验 #H002：高并发与恶意攻击防范

**来源**：项目实战经验  
**优先级**：⭐⭐⭐⭐⭐ (5/5) - 必读  
**标签**：`issue:security` `tech:concurrency` `risk:attack` `stage:development`

#### 核心教训

> **不做防护 = 裸奔上线**。任何公开接口都可能被恶意攻击，必须提前做好防范。

#### 高并发防护

| 问题 | 优化前 | 优化后 | 差异 |
|------|--------|--------|------|
| 库存超卖 | 直接扣减 | 事务+乐观锁 | 数据一致性100% |
| 接口被刷 | 无限制 | Rate Limiting | 防止服务崩溃 |
| 数据库压力 | 直接查询 | 缓存+队列 | 10x性能提升 |

#### 恶意攻击防范清单

```
1. 接口鉴权 - 所有敏感接口需要登录态
2. 参数校验 - 类型、范围、长度全面检查
3. 频率限制 - 单用户请求上限
4. 防重放   - 请求签名+时间戳+nonce
5. 防注入   - 参数化查询，不拼接SQL
6. 防XSS    - 输出转义，不信任用户输入
7. IP黑名单 - 自动封禁异常IP
8. 验证码   - 关键操作前人机验证
```

#### 记住这句话

> **设计系统时，假设每个用户都是黑客。** 只有这样才能设计出安全的系统。

---

**文档版本**：v1.1  
**更新时间**：2026-02-06  
**新增内容**：高优先级经验（积分/支付三重审核、高并发/攻击防范）  
**基于项目**：星见StelRen小程序
